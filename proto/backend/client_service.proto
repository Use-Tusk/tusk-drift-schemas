syntax = "proto3";
package tusk.drift.backend.v1;

option go_package = "./backend";

service ClientService {
  rpc GetAuthInfo(GetAuthInfoRequest) returns (GetAuthInfoResponse);
  rpc CreateObservableService(CreateObservableServiceRequest) returns (CreateObservableServiceResponse);
  rpc VerifyRepoAccess(VerifyRepoAccessRequest) returns (VerifyRepoAccessResponse);
  rpc CreateApiKey(CreateApiKeyRequest) returns (CreateApiKeyResponse);

  // Get observable service info including default branch
  rpc GetObservableServiceInfo(GetObservableServiceInfoRequest) returns (GetObservableServiceInfoResponse);
}

message GetAuthInfoRequest {
  optional string client_id = 1;
}

enum UserType {
  USER_TYPE_UNSPECIFIED = 0;
  USER_TYPE_USER = 1;
  USER_TYPE_API_KEY = 2;
}

message UserAuthInfo {
  string id = 1;
  UserType type = 2;
  string name = 3;
  optional string email = 4;
  optional string code_hosting_username = 5;
}

message AuthInfoClient {
  string id = 1;
  optional string name = 2;
  optional string domain = 3;
  repeated string feature_flags = 4;
  repeated CodeHostingResource code_hosting_resources = 5;
}

enum CodeHostingResourceType {
  CODE_HOSTING_RESOURCE_TYPE_UNSPECIFIED = 0;
  CODE_HOSTING_RESOURCE_TYPE_GITHUB = 1;
  CODE_HOSTING_RESOURCE_TYPE_GITLAB = 2;
}

message CodeHostingResource {
  int64 id = 1;
  CodeHostingResourceType type = 2;
  string external_id = 3;
}

message GetAuthInfoResponse {
  UserAuthInfo user = 1;
  repeated AuthInfoClient clients = 2;
}

message CreateObservableServiceRequest {
  string repo_owner_name = 1;
  string repo_name = 2;
  ServiceType service_type = 3;
  optional string app_dir = 4;
  optional string name = 5;
}

enum ServiceType {
  SERVICE_TYPE_UNSPECIFIED = 0;
  SERVICE_TYPE_NODE = 1;
  SERVICE_TYPE_PYTHON = 2;
}

message CreateObservableServiceResponseSuccess {
  string observable_service_id = 1;
}

enum CreateObservableServiceResponseErrorCode {
  CREATE_OBSERVABLE_SERVICE_RESPONSE_ERROR_CODE_UNSPECIFIED = 0;
  CREATE_OBSERVABLE_SERVICE_RESPONSE_ERROR_CODE_INTERNAL = 1;
  CREATE_OBSERVABLE_SERVICE_RESPONSE_ERROR_CODE_NOT_AUTHORIZED = 2;
  CREATE_OBSERVABLE_SERVICE_RESPONSE_ERROR_CODE_NO_CODE_HOSTING_RESOURCE = 3;
  CREATE_OBSERVABLE_SERVICE_RESPONSE_ERROR_CODE_NO_REPO_FOUND = 4;
}

message CreateObservableServiceResponseError {
  CreateObservableServiceResponseErrorCode code = 1;
  string message = 2;
}

message CreateObservableServiceResponse {
  oneof response {
    CreateObservableServiceResponseSuccess success = 1;
    CreateObservableServiceResponseError error = 2;
  }
}

message VerifyRepoAccessRequest {
  string repo_owner_name = 1;
  string repo_name = 2;
}

message VerifyRepoAccessResponseSuccess {
  int64 repo_id = 1;
}

enum VerifyRepoAccessResponseErrorCode {
  VERIFY_REPO_ACCESS_RESPONSE_ERROR_CODE_UNSPECIFIED = 0;
  VERIFY_REPO_ACCESS_RESPONSE_ERROR_CODE_INTERNAL = 1;
  VERIFY_REPO_ACCESS_RESPONSE_ERROR_CODE_NOT_AUTHORIZED = 2;
  VERIFY_REPO_ACCESS_RESPONSE_ERROR_CODE_NO_CODE_HOSTING_RESOURCE = 3;
  VERIFY_REPO_ACCESS_RESPONSE_ERROR_CODE_REPO_NOT_FOUND = 4;
}

message VerifyRepoAccessResponseError {
  VerifyRepoAccessResponseErrorCode code = 1;
  string message = 2;
}

message VerifyRepoAccessResponse {
  oneof response {
    VerifyRepoAccessResponseSuccess success = 1;
    VerifyRepoAccessResponseError error = 2;
  }
}

message CreateApiKeyRequest {
  string name = 1;
}

message CreateApiKeyResponse {
  oneof response {
    CreateApiKeyResponseSuccess success = 1;
    CreateApiKeyResponseError error = 2;
  }
}

message CreateApiKeyResponseSuccess {
  string api_key_id = 1;
  string api_key = 2;
}

enum CreateApiKeyResponseErrorCode {
  CREATE_API_KEY_RESPONSE_ERROR_CODE_UNSPECIFIED = 0;
  CREATE_API_KEY_RESPONSE_ERROR_CODE_INTERNAL = 1;
  CREATE_API_KEY_RESPONSE_ERROR_CODE_NOT_AUTHORIZED = 2;
}

message CreateApiKeyResponseError {
  CreateApiKeyResponseErrorCode code = 1;
  string message = 2;
}

// =============================================================================
// GetObservableServiceInfo Messages
// =============================================================================

message GetObservableServiceInfoRequest {
  string observable_service_id = 1;
}

message GetObservableServiceInfoResponseSuccess {
  string observable_service_id = 1;
  string default_branch = 2;
  string repo_owner = 3;
  string repo_name = 4;
}

message GetObservableServiceInfoResponseError {
  string code = 1;
  string message = 2;
}

message GetObservableServiceInfoResponse {
  oneof response {
    GetObservableServiceInfoResponseSuccess success = 1;
    GetObservableServiceInfoResponseError error = 2;
  }
}
